<%- include('../partials/header') %>
<%- include('../partials/scripts') %>
<%- include('../partials/select2') %>
<script>
	function addStudentRow(i = $('div#students .row').length, motherDOM = $('div#students')) {
		$('<div>', { class: 'row' }).append(
			$('<div>', { class: 'col-2' }).append(
				$('<div>', { class: 'form-group' }).append(
					$('<label>', { for: `student-${i}-position` }).text('Zaměření (Pozice)'),
					$('<select>', { class: 'form-control', id: `student-${i}-position`, required: 'required' })
				)
			),
			$('<div>', { class: 'col' }).append(
				$('<div>', { class: 'form-group' }).append(
					$('<label>', { for: `student-${i}-task` }).text('Popis pozice'),
					$('<textarea>', {
						class: 'form-control', id: `student-${i}-task`, rows: '1', required: 'required',
						placeholder: 'Zde se prosím rozepište o studentově úkolu'
					})
				)
			),
			$('<div>', { class: 'col-4' }).append(
				$('<div>', { class: 'form-group' }).append(
					$('<label>', { for: `student-${i}-user` }).text('Student'),
					$('<select>', { class: 'form-control', id: `student-${i}-user` })
				)
			),
			$('<div>', { class: 'col-1 m-auto' }).append(
				$('<button>', { class: 'btn btn-danger m-auto', type: 'button', onclick: '$(this).parent().parent().remove()' }).html('&times;')
			)
		).appendTo(motherDOM)
		let $selectPosition = $(`select#student-${i}-position`).select2({
			minimumResultsForSearch: -1
		})
		$selectPosition.html(`<option selected="selected" value>Načítání...</option>`)
		$selectPosition.prop("disabled", true);
		API.specialization.list().done((listOfSpecializations) => {
			$selectPosition.html(`<option selected="selected" value disabled="disabled">Vyberte zaměření</option>`)
			listOfSpecializations.forEach((specialization) => {
				$selectPosition.append(`<option value="${specialization._id}">${specialization.name}</option>`)
			})
			$selectPosition.prop("disabled", false);
		})

		let $selectStudent = $(`select#student-${i}-user`).select2()
		$selectStudent.html(`<option selected="selected" value>Načítání...</option>`)
		$selectStudent.prop("disabled", true);
		API.user.list().done((listOfUsers) => {
			$selectStudent.html(`<option selected="selected" value disabled="disabled">Vyberte uživatele</option>`)
			listOfUsers.forEach((user) => {
				$selectStudent.append(`<option value="${user._id}">${user.name.first} ${user.name.middle !== undefined ? `${user.name.middle} ` : ''}${user.name.last}</option>`)
			})
			$selectStudent.prop("disabled", false);
		})
	}

	function addGuarantorRow(i = $('div#guarantors .row').length, motherDOM = $('div#guarantors')) {
		$('<div>', { class: 'row' }).append(
			$('<div>', { class: 'col' }).append(
				$('<div>', { class: 'form-group' }).append(
					$('<label>', { for: `guarantor-${i}-task` }).text('Popis páce'),
					$('<textarea>', {
						class: 'form-control', id: `guarantor-${i}-task`, rows: '1', required: 'required',
						placeholder: 'Zde se prosím rozepište o garantově zadaní'
					})
				)
			),
			$('<div>', { class: 'col-4' }).append(
				$('<div>', { class: 'form-group' }).append(
					$('<label>', { for: `guarantor-${i}-user` }).text('Učitel'),
					$('<select>', { class: 'form-control', id: `guarantor-${i}-user`, required: 'required' })
				)
			),
			$('<div>', { class: 'col-1 m-auto' }).append(
				$('<button>', { class: 'btn btn-danger m-auto', type: 'button', onclick: '$(this).parent().parent().remove()' }).html('&times;')
			)
		).appendTo(motherDOM)
		let $selectGuarantor = $(`select#guarantor-${i}-user`).select2()
		$selectGuarantor.html(`<option selected="selected" value>Načítání...</option>`)
		$selectGuarantor.prop("disabled", true);
		API.user.list().done((listOfUsers) => {
			$selectGuarantor.html(`<option selected="selected" value>Vyberte uživatele</option>`)
			listOfUsers.forEach((user) => {
				$selectGuarantor.append(`<option value="${user._id}">${user.name.first} ${user.name.middle !== undefined ? `${user.name.middle} ` : ''}${user.name.last}</option>`)
			})
			$selectGuarantor.prop("disabled", false);
		})
	}

	function getDataForRequest() {
		let students = []
		for (let i = 0; i < $('div#students .row').length; i++) {
			let student = {}
			student.position = $(`#student-${i}-position`).val()
			student.task = $(`#student-${i}-task`).val()
			let userId = $(`#student-${i}-user`).val()
			if (userId !== null || userId !== '') {
				student.user = userId
			}
			students.push(student)
		}

		let guarantors = []
		for (let i = 0; i < $('div#guarantors .row').length; i++) {
			let guarantor = {}
			guarantor.task = $(`#guarantor-${i}-task`).val()
			guarantor.user = $(`#guarantor-${i}-user`).val()
			guarantors.push(guarantor)
		}

		return {
			name: $('#name').val(),
			description: $('#description').val(),
			students: students,
			guarantors: guarantors
		}
	}

	$(document).ready(() => {
		for (let i = 0; i < 2; i++) {
			addStudentRow()
			addGuarantorRow()
		}

		$('form#new-teamwork').submit(function (event) {
			event.preventDefault()
			let $status = $('div#new-teamwork-status')
			$status
				.empty()
				.append(
					$('<div>', { class: 'alert alert-info alert-dismissible' }).append(
						$('<a>', { href: '#', class: 'close', 'data-dismiss': 'alert', 'aria-label': 'close' }).html('&times;'),
						// $('<strong>').text('Gratuluji!'),
						'Zpracovávám'
					)
				)
				.show()

			API.teamwork.new(
				getDataForRequest().name,
				getDataForRequest().description,
				getDataForRequest().students,
				getDataForRequest().guarantors
			).done(function (responseFromServer) {
				if (responseFromServer === 'ok') {
					$status
						.empty()
						.append(
							$('<div>', { class: 'alert alert-success alert-dismissible' }).append(
								$('<a>', { href: '#', class: 'close', 'data-dismiss': 'alert', 'aria-label': 'close' }).html('&times;'),
								$('<strong>').text('Gratuluji!'),
								' Úspěšně jste vytvořil(a) novou týmovou práci'
							)
						)
						.show()

					// Redirect to teamworks page
					setTimeout(function () {
						window.location.href = window.location.href;
					}, 3500)
				} else {
					$status
						.empty()
						.append(
							$('<div>', { class: 'alert alert-danger alert-dismissible' }).append(
								$('<a>', { href: '#', class: 'close', 'data-dismiss': 'alert', 'aria-label': 'close' }).html('&times;'),
								$('<strong>').text('Ach ne! '),
								responseFromServer
							)
						)
						.show()
				}
			})
		})
	})
</script>
</head>

<body class="min-vh-100 d-flex flex-column">
	<%- include('../partials/navbar') %>
	<div class="main-content d-flex flex-column flex-grow-1">
		<%- include('../partials/topbar') %>
		<%- include('./header', { active: 'new' }) %>
		<!-- Page content -->
		<div class="container-fluid mt--7 flex-grow-1">
			<div class="row">
				<div class="col-xl-12">
					<div class="card">
						<div class="card-header">
							<div class="row align-items-center">
								<div class="col-12">
									<h3 class="mb-0">Nová týmovka</h3>
								</div>
							</div>
						</div>
						<div class="card-body bg-secondary">
							<form action="./" method="POST" id="new-teamwork">
								<h6 class="heading text-muted mb-4">Základní údaje</h6>
								<div class="pl-lg-4">
									<div class="row">
										<div class="col">
											<div class="form-group">
												<label class="form-control-label" for="name">Název</label>
												<input type="text" id="name" class="form-control" required
													placeholder="Vyplňte prosím toto povinné pole">
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col">
											<div class="form-group">
												<label for="description">Popis</label>
												<textarea class="form-control" id="description" rows="3" required
													placeholder="Zde se prosím rozepište o zadání týmové práce"></textarea>
											</div>
										</div>
									</div>
								</div>
								<hr class="my-4">
								<div class="row">
									<div class="col float-left">
										<h6 class="heading text-muted mb-4">Studenti</h6>
									</div>
									<div class="col float-right">
										<button type="button" onclick="addStudentRow()"
											class="btn btn-sm btn-primary float-right">Přidat studenta</button>
									</div>
								</div>
								<div class="pl-lg-4" id="students"></div>
								<hr class="my-4">
								<div class="row">
									<div class="col float-left">
										<h6 class="heading text-muted mb-4">Garanti</h6>
									</div>
									<div class="col float-right">
										<button type="button" onclick="addGuarantorRow()"
											class="btn btn-sm btn-primary float-right">Přidat garanta</button>
									</div>
								</div>
								<div class="pl-lg-4" id="guarantors"></div>
								<div class="pl-lg-4">
									<div class="row">
										<div class="col" id="new-teamwork-status" style="display: none;"></div>
										<div class="col-4 text-left">
											<button type="submit" class="btn btn-primary"
												id="new-teamwork-button">Vytvořit</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<%- include('../partials/footer') %>
		</div>
	</div>
	<%- include('../partials/scripts-file-end') %>
	<%- include('../partials/file-end') %>